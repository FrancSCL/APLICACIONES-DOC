<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papeleta de Aplicación - LH-APLICACIONES-DOCS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
<div class="container">
    <div class="app-title">LH-APLICACIONES-DOCS</div>
    <h1>Papeleta de Aplicación</h1>

    {% if error_message %}
        <div style="background-color: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 15px; margin: 20px 0; border-radius: 4px;">
            <strong>Error:</strong> {{ error_message }}
            <br><small>Por favor, verifica la configuración de la base de datos o contacta al administrador.</small>
        </div>
    {% endif %}

    <form method="post" class="form-card">
        <label for="id_sucursal">1. Seleccione una sucursal (fundo):</label>
        <select name="id_sucursal" id="id_sucursal" required>
            <option value="">-- Seleccione sucursal --</option>
            {% for s in sucursales %}
                <option value="{{ s.id }}"
                        {% if sucursal_seleccionada and sucursal_seleccionada|string == s.id|string %}selected{% endif %}>
                    {{ s.sucursal }}
                </option>
            {% endfor %}
        </select>

        {% if sucursal_seleccionada %}
            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                <div>
                    <label for="anio">2. Año (opcional):</label>
                    <input type="number" name="anio" id="anio"
                           min="2000" max="2100"
                           value="{{ anio_seleccionado or '' }}"
                           style="width: 110px;">
                </div>
                <div>
                    <label for="mes">3. Mes (opcional):</label>
                    <select name="mes" id="mes" style="width: 140px;">
                        <option value="">-- Todos los meses --</option>
                        {% for m in range(1,13) %}
                            <option value="{{ m }}"
                                    {% if mes_seleccionado and mes_seleccionado == m %}selected{% endif %}>
                                {{ "%02d"|format(m) }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        {% endif %}

        {% if sucursal_seleccionada %}
            <label for="id_aplicacion" style="margin-top: 10px;">4. Seleccione una aplicación fitosanitaria:</label>
            <select name="id_aplicacion" id="id_aplicacion">
                <option value="">-- Seleccione aplicación --</option>
                {% for a in aplicaciones %}
                    <option value="{{ a.id_aplicacion }}"
                            {% if aplicacion_seleccionada and aplicacion_seleccionada.id_aplicacion == a.id_aplicacion %}selected{% endif %}>
                        {{ a.folio }} - {{ a.fecha_planificacion }}
                    </option>
                {% endfor %}
            </select>
        {% endif %}

        <button type="submit" class="btn btn-primary">
            {% if sucursal_seleccionada %}Confirmar aplicación{% else %}Filtrar por sucursal{% endif %}
        </button>
    </form>

    {% if aplicacion_seleccionada %}
        <div class="info-box">
            <p><strong>Folio:</strong> {{ aplicacion_seleccionada.folio }}</p>
            <p><strong>Fecha planificación:</strong> {{ aplicacion_seleccionada.fecha_planificacion }}</p>
            
            <div style="margin-top: 20px;">
                <a class="btn btn-secondary"
                   href="{{ url_for('papeleta_pdf', id_aplicacion=aplicacion_seleccionada.id_aplicacion) }}">
                    Generar PDF
                </a>
            </div>
        </div>
    {% endif %}

    <div class="back-link">
        <a href="{{ url_for('index') }}">&larr; Volver al menú principal</a>
    </div>
</div>
</body>

<script>
// Auto-refresca la lista de aplicaciones al cambiar sucursal / año / mes
document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form.form-card');
    if (!form) return;

    const sucursal = document.getElementById('id_sucursal');
    const anio = document.getElementById('anio');
    const mes = document.getElementById('mes');

    function autoSubmit() {
        const appSelect = document.getElementById('id_aplicacion');
        if (appSelect) {
            appSelect.value = '';  // limpiar selección de aplicación al cambiar filtros
        }
        form.submit();
    }

    [sucursal, anio, mes].forEach(function (el) {
        if (el) {
            el.addEventListener('change', autoSubmit);
        }
    });
});
</script>
</body>
</html>
